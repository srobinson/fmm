# CONTROL — architecture-overview
# Query: Describe the architecture of this project. What are the main modules, their roles, key exports, and how they depend on each other? Be specific about file paths.
# Duration: 93s
# Tool calls: 25
# Files read: 19
# Tokens: 313664 in / 4925 out
# Cost: $0.0025
# FMM discovered: False
# Manifest used: False

## Tool Call Sequence

  1. Bash(pwd)
  2. Bash(ls -la)
  3. Glob(**/*.json)
  4. Glob(**/*.ts)
  5. Glob(**/*.tsx)
  6. Bash(tree -d src/)
  7. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/index.ts)
  8. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/tsconfig.json)
  9. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/config/app.ts)
  10. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/api/routes/auth.ts)
  11. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/api/routes/users.ts)
  12. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/api/controllers/authController.ts)
  13. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/api/models/user.ts)
  14. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/api/models/session.ts)
  15. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/auth/types.ts)
  16. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/auth/login.ts)
  17. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/auth/signup.ts)
  18. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/auth/jwt.ts)
  19. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/auth/password.ts)
  20. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/middleware/auth.ts)
  21. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/middleware/rateLimit.ts)
  22. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/services/audit.ts)
  23. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/services/email.ts)
  24. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/utils/id.ts)
  25. Read(/Users/alphab/Dev/LLM/DEV/fmm-worktrees/nancy-ALP-409/research/exp14/repos/clean/src/utils/validation.ts)

## LLM Response

I'll analyze the project architecture by exploring its structure and key files.
Now let me read the key files from each module to understand their roles and dependencies:
Perfect! Now I have a comprehensive view of the project architecture. Let me provide you with a detailed architectural analysis:

## Project Architecture Overview

This is a **TypeScript-based authentication and user management backend application** with a modular, layered architecture. The project follows a clean separation of concerns with distinct modules for different responsibilities.

---

## Directory Structure

```
src/
├── api/              # API layer (routes, controllers, models)
├── auth/             # Authentication business logic
├── config/           # Application configuration
├── middleware/       # Request middleware
├── services/         # External service integrations
└── utils/            # Utility functions
```

---

## Core Modules & Dependencies

### 1. **Entry Point: `src/index.ts`**
**Role:** Application bootstrap and initialization

**Key Exports:**
- `createApp()` - Main application factory function

**Dependencies:**
- `src/config/app.ts` (config, validateConfig)
- `src/api/routes/auth.ts` (getAuthRoutes)
- `src/api/routes/users.ts` (getUserRoutes)
- `src/middleware/rateLimit.ts` (rateLimiter)

**Responsibilities:**
- Validates configuration
- Assembles routes from auth and user modules
- Sets up global middleware (rate limiting)
- Provides app.start() method

---

### 2. **Configuration: `src/config/app.ts`**
**Role:** Centralized configuration management

**Key Exports:**
- `AppConfig` interface
- `config` object (reads from environment variables)
- `validateConfig()` function

**Dependencies:** None (leaf module)

**Provides:**
- Port configuration
- JWT settings (secret, expiry)
- Bcrypt rounds
- Rate limiting settings
- Log levels

---

### 3. **API Layer**

#### **3a. Routes: `src/api/routes/auth.ts`**
**Role:** Authentication endpoint definitions

**Key Exports:**
- `getAuthRoutes()` - Returns array of auth route configurations

**Dependencies:**
- `src/auth/login.ts` (authenticateUser, validateSession)
- `src/auth/signup.ts` (registerUser, validateSignupData)
- `src/auth/jwt.ts` (refreshToken)
- `src/middleware/auth.ts` (authMiddleware, AuthenticatedRequest, Response)
- `src/middleware/rateLimit.ts` (authRateLimiter)

**Routes:**
- POST `/auth/login` - User login
- POST `/auth/signup` - User registration
- POST `/auth/refresh` - Token refresh
- GET `/auth/me` - Get current user

#### **3b. Routes: `src/api/routes/users.ts`**
**Role:** User management endpoint definitions

**Key Exports:**
- `getUserRoutes()` - Returns array of user route configurations

**Dependencies:**
- `src/api/models/user.ts` (findUserById, listUsers, updateUser, deleteUser)
- `src/middleware/auth.ts` (authMiddleware, requireRole, AuthenticatedRequest, Response)

**Routes:**
- GET `/users` - List all users (admin only)
- GET `/users/:id` - Get user by ID
- PUT `/users/:id` - Update user
- DELETE `/users/:id` - Delete user (admin only)

#### **3c. Controller: `src/api/controllers/authController.ts`**
**Role:** Higher-level auth controller (alternative to route handlers)

**Key Exports:**
- `AuthController` class
- `createAuthController()` factory

**Dependencies:**
- `src/auth/login.ts` (authenticateUser)
- `src/auth/signup.ts` (registerUser)
- `src/services/audit.ts` (logAuthEvent)
- `src/auth/types.ts` (LoginCredentials, SignupData)

**Note:** Provides additional audit logging compared to route handlers

#### **3d. Models: `src/api/models/user.ts`**
**Role:** User data model and persistence layer

**Key Exports:**
- `User` interface
- `createUser()`, `findUserByEmail()`, `findUserById()`
- `listUsers()`, `updateUser()`, `deleteUser()`, `countUsers()`

**Dependencies:**
- `src/auth/types.ts` (UserRole)
- `src/utils/id.ts` (generateId)

**Storage:** In-memory Map (not production-ready, but good for testing)

#### **3e. Models: `src/api/models/session.ts`**
**Role:** Session management and persistence

**Key Exports:**
- `Session` interface
- `createSession()`, `findSessionByToken()`
- `deleteSessionsByUser()`, `cleanExpiredSessions()`

**Dependencies:**
- `src/utils/id.ts` (generateId)

**Storage:** In-memory Map

---

### 4. **Authentication Module**

#### **4a. Types: `src/auth/types.ts`**
**Role:** Shared authentication type definitions

**Key Exports:**
- `UserPayload`, `UserRole`, `AuthResult`
- `LoginCredentials`, `SignupData`, `PasswordResetRequest`

**Dependencies:** None (leaf module)

#### **4b. Login: `src/auth/login.ts`**
**Role:** Login authentication logic

**Key Exports:**
- `authenticateUser()` - Validates credentials and returns token
- `validateSession()` - Validates JWT token

**Dependencies:**
- `src/auth/types.ts` (LoginCredentials, AuthResult, UserPayload)
- `src/auth/jwt.ts` (generateToken, verifyToken)
- `src/api/models/user.ts` (findUserByEmail)
- `src/auth/password.ts` (verifyPassword)
- `src/services/audit.ts` (logAuthEvent)

#### **4c. Signup: `src/auth/signup.ts`**
**Role:** User registration logic

**Key Exports:**
- `registerUser()` - Creates new user account
- `validateSignupData()` - Validates registration data

**Dependencies:**
- `src/auth/types.ts` (SignupData, AuthResult, UserPayload)
- `src/auth/jwt.ts` (generateToken)
- `src/api/models/user.ts` (createUser, findUserByEmail)
- `src/auth/password.ts` (hashPassword)
- `src/services/audit.ts` (logAuthEvent)
- `src/services/email.ts` (sendWelcomeEmail)

#### **4d. JWT: `src/auth/jwt.ts`**
**Role:** JWT token generation and verification

**Key Exports:**
- `generateToken()` - Creates JWT token
- `verifyToken()` - Validates and decodes JWT
- `refreshToken()` - Generates new token from existing

**Dependencies:**
- `src/config/app.ts` (config)
- `src/auth/types.ts` (UserPayload)

**Note:** Uses custom HMAC implementation (not production-grade)

#### **4e. Password: `src/auth/password.ts`**
**Role:** Password hashing and verification

**Key Exports:**
- `hashPassword()` - Hashes password with salt
- `verifyPassword()` - Verifies password against hash
- `validatePasswordStrength()` - Checks password strength

**Dependencies:**
- `src/config/app.ts` (config)

**Note:** Uses custom PBKDF2 implementation (simplified)

---

### 5. **Middleware**

#### **5a. Auth Middleware: `src/middleware/auth.ts`**
**Role:** Request authentication and authorization

**Key Exports:**
- `authMiddleware` - Requires valid JWT token
- `requireRole()` - Factory for role-based authorization
- `optionalAuth` - Optional authentication
- `AuthenticatedRequest`, `Response` interfaces

**Dependencies:**
- `src/auth/jwt.ts` (verifyToken)
- `src/auth/types.ts` (UserPayload, UserRole)

#### **5b. Rate Limiting: `src/middleware/rateLimit.ts`**
**Role:** Request rate limiting

**Key Exports:**
- `rateLimiter()` - Generic rate limiter factory
- `authRateLimiter()` - Preconfigured for auth endpoints
- `clearRateLimitStore()` - Testing utility

**Dependencies:**
- `src/middleware/auth.ts` (AuthenticatedRequest, Response)

**Storage:** In-memory Map with time-based reset

---

### 6. **Services**

#### **6a. Audit Service: `src/services/audit.ts`**
**Role:** Authentication event logging

**Key Exports:**
- `AuditEntry` interface
- `logAuthEvent()` - Logs authentication events
- `getAuditLog()` - Retrieves logs with filters
- `clearAuditLog()` - Testing utility

**Dependencies:** None (leaf module)

**Storage:** In-memory array

#### **6b. Email Service: `src/services/email.ts`**
**Role:** Email sending abstraction

**Key Exports:**
- `EmailMessage` interface
- `sendWelcomeEmail()`, `sendPasswordResetEmail()`
- `sendEmail()` - Generic email sender
- `getSentEmails()`, `clearSentEmails()` - Testing utilities

**Dependencies:** None (leaf module)

**Storage:** In-memory array (mock implementation)

---

### 7. **Utilities**

#### **7a. ID Generation: `src/utils/id.ts`**
**Role:** Unique identifier generation

**Key Exports:**
- `generateId()` - Creates unique IDs
- `isValidId()` - Validates ID format
- `extractTimestamp()` - Extracts timestamp from ID

**Dependencies:** None (leaf module)

**Format:** `{timestamp}-{random}-{sequence}`

#### **7b. Validation: `src/utils/validation.ts`**
**Role:** Input validation and sanitization

**Key Exports:**
- `isValidEmail()` - Email validation
- `sanitizeInput()` - XSS prevention
- `truncate()` - String truncation
- `parseQueryParams()` - Query string parsing

**Dependencies:** None (leaf module)

---

## Dependency Graph (High-Level)

```
index.ts
├─► config/app.ts
├─► api/routes/auth.ts
│   ├─► auth/login.ts
│   │   ├─► auth/jwt.ts ──► config/app.ts
│   │   ├─► api/models/user.ts ──► utils/id.ts
│   │   ├─► auth/password.ts ──► config/app.ts
│   │   └─► services/audit.ts
│   ├─► auth/signup.ts
│   │   ├─► auth/jwt.ts
│   │   ├─► api/models/user.ts
│   │   ├─► auth/password.ts
│   │   ├─► services/audit.ts
│   │   └─► services/email.ts
│   ├─► auth/jwt.ts
│   └─► middleware/auth.ts ──► auth/jwt.ts
├─► api/routes/users.ts
│   ├─► api/models/user.ts
│   └─► middleware/auth.ts
└─► middleware/rateLimit.ts
```

---

## Key Design Patterns

1. **Layered Architecture**: Clear separation between API, business logic, and data layers
2. **Factory Pattern**: `createApp()`, `createAuthController()`, `requireRole()`
3. **Middleware Pattern**: Express-style middleware for auth and rate limiting
4. **Repository Pattern**: Model files abstract data access
5. **Service Layer**: Separate services for cross-cutting concerns (audit, email)

---

## Notes

- All data storage is **in-memory** (Maps/Arrays) - not production-ready
- Custom implementations of JWT and password hashing - simplified for demonstration
- Type-safe throughout with TypeScript strict mode
- No external dependencies visible (self-contained)
- Testing utilities provided (clear functions for stores)