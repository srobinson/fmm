# exp15-isolated: Docker Compose for fully isolated experiment runs
#
# Usage:
#   docker compose run condition-a 0 1    # Condition A, task 0, run 1
#   docker compose run condition-d 2 3    # Condition D, task 2, run 3
#
# All conditions share:
#   - Same base image (fmm-exp)
#   - Same codebase mount (read-only)
#   - Same results output volume
#   - API key from .env file
#
# Each condition gets:
#   - Fresh container per run (no shared state)
#   - No shared prompt cache
#   - Condition letter pre-set via environment

x-base: &base
  build:
    context: .
    dockerfile: Dockerfile
  env_file: .env
  volumes:
    - ${CODEBASE_PATH:-.}/codebase:/codebase:ro
    - ./results:/results
  tmpfs:
    - /tmp:size=512M
    - /root/.claude:size=64M
  network_mode: "none"

services:
  condition-a:
    <<: *base
    entrypoint: ["entrypoint.sh", "A"]

  condition-b:
    <<: *base
    entrypoint: ["entrypoint.sh", "B"]

  condition-c:
    <<: *base
    entrypoint: ["entrypoint.sh", "C"]

  condition-d:
    <<: *base
    entrypoint: ["entrypoint.sh", "D"]
